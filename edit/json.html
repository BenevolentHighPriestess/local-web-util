<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>json 查看</title>
    <style>
        p {
            margin: 1em auto;
            width: 90%;
        }

        textarea {
            width: 100%;
        }
    </style>
</head>

<body>

    <p>
        <!-- 混乱的json数据-->
        <textarea id="chaosTextarea" rows="5"></textarea>
    </p>


    <p>
        只显示的字段名 空格隔开 ( firstName postalCode)<input style="width: 80%" id="replacerInput">
    </p>
    <p>
        间隔符号(默认为4个空格,为空则为一行展示)<input id='space' value="    ">
    </p>

    <p>
        <strong>选择json数据</strong>

        <span id="radioSpan">
        </span>

    </p>

    <p>
        <button onclick="extract()" style="font-size: x-large"> 提取 展示 </button>
    </p>

    <p>
        <!--格式化展示的数据-->
        <textarea id="jsonTextarea" rows="40"></textarea>
    </p>

    <script>

        const demoStr = `2019-07-28 15:52:30.013  INFO 9272 --- [           main] com.example.demo.DemoApplication         : person:{"firstName":"John","lastName":"Smith","isAlive":true,"age":27,"address":{"streetAddress":"21 2nd Street","city":"New York","state":"NY","postalCode":"10021-3100","area":"{\\"Total\\":\\"468.484 sq mi (1,213.37 km2)\\",\\"Land\\":\\"302.643 sq mi (783.84 km2)\\",\\"Water\\":\\"165.841 sq mi (429.53 km2)\\",\\"Metro\\":\\"Hello 13,318 sq mi (34,490 km2)\\"}"},"phoneNumbers":[{"type":"home","number":"212 555-1234"},{"type":"office","number":"646 555-4567"},{"type":"mobile","number":"123 456-7890"}],"children":[],"spouse":null,"extra":"{\\"Array\\":[1,2,3],\\"Boolean\\":true,\\"Null\\":null,\\"Number\\":123,\\"Object\\":{\\"a\\":\\"b\\",\\"c\\":\\"d\\"},\\"String\\":\\"Hello World\\"}"}`;

        chaosTextarea.value = demoStr;


        let jsons = [];//匹配二维二维数组 0是字符串 1是json对象 2 是对象名
        function radioChange() {
            let replacer = replacerInput.value.split(" ").filter(str => str.length > 0);
            console.log(replacer);
            if (replacer.length == 0) {
                replacer = null;//为空则是全部显示
            }
            let checkValue = document.querySelector('input[name="radio"]:checked');
            checkValue = checkValue ? checkValue.value : 0;//默认为0
            jsonTextarea.value = JSON.stringify(jsons[checkValue][1], replacer, space.value);
        }

        function extract() {
            jsons = [];
            let chaosText = chaosTextExtract(chaosTextarea.value);
            if (chaosText && chaosText.length > 0) {
                jsons.push([...chaosText, 'main']);
                extractObj(chaosText[1], 'main');
            }

            radioSpan.innerHTML = jsons.
                map((jsonInfo, index) => ` <input type="radio" name='radio' value="${index}"> ${jsonInfo[2]}   `)
                .reduce((acc, cur, idx) => acc += cur);


            document.querySelectorAll('input[name="radio"]').forEach(radio => radio.addEventListener('change', radioChange));
            radioChange();
        }

        //对象提取 json
        //obj 提取的对象
        //name 提取的对象名
        function extractObj(obj, name) {
            for (let prop in obj) {
                //如果此属性是 字符串 判断是否是json
                if (typeof obj[prop] === 'string') {
                    console.log('String ' + obj[prop]);
                    let chaosText2 = chaosTextExtract(obj[prop]);
                    if (chaosText2 && chaosText2.length > 0) {
                        jsons.push([...chaosText2, name + ' => ' + prop]);
                    }
                } else if (typeof obj[prop] === 'object') {
                    //递归调用
                    extractObj(obj[prop], name + ' => ' + prop)
                }
                console.log("obj." + prop + " = " + obj[prop]);
            }
        }


        /*混乱文本中抽取json 
          返回长度为2的数组 第一位是 文字字符 第二位是json对象
        */
        function chaosTextExtract(chaosTextStr) {
            //json 的头尾标识
            const marks = [['{', '}'], ['[', ']']];
            //marks 一样长度的多维数组 , 只不过 原来字符 改为字符所在数组
            let marksPosition = [[[], []], [[], []]];;//匹配json的头尾字符所在位置

            let jsonList = [];//匹配中的json对象 0存放原有字符串 1存放转换后josn对象

            //记住所有json标识所在位置
            for (let i = 0; i < chaosTextStr.length; i++) {
                switch (chaosTextStr.charAt(i)) {
                    case marks[0][0]: marksPosition[0][0].push(i); break;
                    case marks[0][1]: marksPosition[0][1].push(i); break;
                    case marks[1][0]: marksPosition[1][0].push(i); break;
                    case marks[1][1]: marksPosition[1][1].push(i); break;
                }
            }

            marksPosition.forEach(position0 => {
                position0[0].forEach(position00 => {
                    position0[1].filter(position01 => position01 > position00).forEach(position01 => {
                        let text = chaosTextStr.substr(position00, position01 + 1);
                        try {
                            let obj = JSON.parse(text);
                            jsonList.push([text, obj]);
                        } catch (error) {
                        }
                    });
                });
            });
            //排序
            console.log(jsonList);
            jsonList.sort((a, b) => a[0].length - b[0].length);
            console.log('find json string length :' + jsonList.length);
            if (jsonList.length > 0) {
                return jsonList[0];
            }
            return null;
        }



    </script>
</body>

</html>